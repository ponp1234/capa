<!-- templates/alerts.html -->
{% extends "base.html" %}

{% block title %}Dotsh - Alerts{% endblock %}

{% block content %}
<style>
    .alert-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 10px 20px;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: #4a5568;
    }
    .filter-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }
    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    .alert-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid;
    }
    .stat-card.critical {
        border-left-color: #e53e3e;
    }
    .stat-card.warning {
        border-left-color: #ed8936;
    }
    .stat-card.info {
        border-left-color: #4299e1;
    }
    .stat-card.all {
        border-left-color: #667eea;
    }
    .stat-label {
        font-size: 13px;
        color: #718096;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #2d3748;
    }
    .alert-row {
        cursor: pointer;
        transition: all 0.2s;
    }
    .alert-row:hover {
        background: #f7fafc !important;
        transform: translateX(4px);
    }
    .alert-detail {
        display: none;
        padding: 20px;
        background: #f7fafc;
        border-left: 4px solid #667eea;
        margin: 10px 0;
    }
    .alert-detail.show {
        display: block;
    }
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    .detail-item {
        background: white;
        padding: 12px;
        border-radius: 6px;
    }
    .detail-label {
        font-size: 12px;
        color: #718096;
        margin-bottom: 4px;
    }
    .detail-value {
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
    }
    .search-alert-box {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }
    .search-alert-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 15px;
        outline: none;
    }
    .search-alert-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }
    .empty-state svg {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        opacity: 0.3;
    }
    .alert-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }
    .action-btn {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .action-btn:hover {
        background: #f7fafc;
        border-color: #cbd5e0;
    }
</style>

<div class="dashboard">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='{{ url_for('dashboard') }}'">
            dotsh<span class="logo-dot">.</span>
        </div>
        
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Overview</span>
            </a>

            <a href="{{ url_for('capacity') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="3" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="10" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="17" width="20" height="5" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Server Capacity</span>
            </a>

            <a href="{{ url_for('projects') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke-width="2"/>
                </svg>
                <span class="tooltip">Project Servers</span>
            </a>

            <a href="{{ url_for('alerts') }}" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke-width="2"/>
                </svg>
                <span class="tooltip">Alerts</span>
            </a>

            <a href="{{ url_for('logout') }}" class="nav-item nav-logout" onclick="return confirm('Are you sure you want to logout?')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke-width="2"/>
                    <polyline points="16 17 21 12 16 7" stroke-width="2"/>
                    <line x1="21" y1="12" x2="9" y2="12" stroke-width="2"/>
                </svg>
                <span class="tooltip">Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="header">
            <h1>Alerts & Notifications</h1>
            <p>Monitor system alerts and warnings across all servers</p>
        </div>

        <!-- Alert Statistics -->
        <div class="alert-stats">
            <div class="stat-card all">
                <div class="stat-label">Total Alerts</div>
                <div class="stat-value" id="totalAlerts">{{ alerts|length }}</div>
            </div>
            <div class="stat-card critical">
                <div class="stat-label">Critical</div>
                <div class="stat-value" id="criticalCount">
                    {{ alerts|selectattr('severity', 'equalto', 'offline')|list|length }}
                </div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">Warning</div>
                <div class="stat-value" id="warningCount">
                    {{ alerts|selectattr('severity', 'equalto', 'warning')|list|length }}
                </div>
            </div>
            <div class="stat-card info">
                <div class="stat-label">Online</div>
                <div class="stat-value" id="infoCount">
                    {{ alerts|selectattr('severity', 'equalto', 'online')|list|length }}
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-alert-box">
            <input type="text" 
                   class="search-alert-input" 
                   id="searchAlerts" 
                   placeholder="Search alerts by server, type, or message..." 
                   onkeyup="searchAlerts()">
            <button class="search-btn" onclick="searchAlerts()">
                <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle;" viewBox="0 0 24 24" fill="none">
                    <circle cx="11" cy="11" r="8" stroke="white" stroke-width="2"/>
                    <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>

        <!-- Filter Buttons -->
        <div class="alert-filters">
            <button class="filter-btn active" onclick="filterAlerts('all')" data-filter="all">
                All Alerts
            </button>
            <button class="filter-btn" onclick="filterAlerts('offline')" data-filter="offline">
                Critical
            </button>
            <button class="filter-btn" onclick="filterAlerts('warning')" data-filter="warning">
                Warning
            </button>
            <button class="filter-btn" onclick="filterAlerts('online')" data-filter="online">
                Online
            </button>
        </div>

        <!-- Alerts Table -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Active Alerts</h2>
                <div class="alert-actions">
                    <button class="action-btn" onclick="refreshAlerts()">
                        🔄 Refresh
                    </button>
                    <button class="action-btn" onclick="exportAlerts()">
                        📥 Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="alertsTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Server</th>
                            <th>Type</th>
                            <th>Message</th>
                            <th>Severity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="alertsTableBody">
                        {% if alerts %}
                            {% for alert in alerts %}
                            <tr class="alert-row" 
                                data-severity="{{ alert.severity }}" 
                                data-alert-id="{{ alert.id }}"
                                onclick="toggleAlertDetail({{ alert.id }})">
                                <td>{{ alert.created_at.strftime('%I:%M %p') }}</td>
                                <td><strong>{{ alert.server.name }}</strong></td>
                                <td>{{ alert.alert_type }}</td>
                                <td>{{ alert.message }}</td>
                                <td>
                                    <span class="status-badge {{ alert.severity }}">
                                        {{ alert.severity|capitalize }}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn" onclick="event.stopPropagation(); acknowledgeAlert({{ alert.id }})">
                                        ✓ Acknowledge
                                    </button>
                                </td>
                            </tr>
                            <tr class="alert-detail" id="detail-{{ alert.id }}">
                                <td colspan="6">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div>
                                            <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 8px;">
                                                Alert Details
                                            </h3>
                                            <p style="color: #718096; font-size: 14px;">
                                                Full information about this alert
                                            </p>
                                        </div>
                                        <span class="status-badge {{ alert.severity }}" style="font-size: 14px; padding: 8px 16px;">
                                            {{ alert.severity|upper }}
                                        </span>
                                    </div>
                                    
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <div class="detail-label">Alert ID</div>
                                            <div class="detail-value">#{{ alert.id }}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Server Name</div>
                                            <div class="detail-value">{{ alert.server.name }}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Server Status</div>
                                            <div class="detail-value">
                                                <span class="status-badge {{ alert.server.status }}">
                                                    {{ alert.server.status|capitalize }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Alert Type</div>
                                            <div class="detail-value">{{ alert.alert_type }}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Created At</div>
                                            <div class="detail-value">{{ alert.created_at.strftime('%b %d, %Y %I:%M %p') }}</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Severity Level</div>
                                            <div class="detail-value">{{ alert.severity|capitalize }}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 20px; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div class="detail-label" style="margin-bottom: 8px;">Full Message</div>
                                        <div style="font-size: 15px; color: #2d3748; line-height: 1.6;">
                                            {{ alert.message }}
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                                        <button class="action-btn" onclick="event.stopPropagation(); acknowledgeAlert({{ alert.id }})" style="padding: 10px 20px;">
                                            ✓ Acknowledge & Close
                                        </button>
                                        <button class="action-btn" onclick="event.stopPropagation(); viewServer('{{ alert.server.name }}')" style="padding: 10px 20px;">
                                            🖥️ View Server Details
                                        </button>
                                        <button class="action-btn" onclick="event.stopPropagation(); escalateAlert({{ alert.id }})" style="padding: 10px 20px;">
                                            ⚠️ Escalate Alert
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2"/>
                                            <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2"/>
                                        </svg>
                                        <h3 style="margin-bottom: 8px; color: #2d3748;">No Alerts</h3>
                                        <p>All systems are running smoothly</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alert Timeline (Optional) -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Alert Timeline</h2>
            </div>
            <div style="padding: 20px; text-align: center; color: #718096;">
                <p>Alert timeline visualization coming soon</p>
            </div>
        </div>
    </div>
</div>

<script>
// Filter alerts by severity
function filterAlerts(severity) {
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter table rows
    const rows = document.querySelectorAll('.alert-row');
    rows.forEach(row => {
        if (severity === 'all' || row.dataset.severity === severity) {
            row.style.display = '';
            // Also show/hide the detail row
            const detailRow = document.getElementById('detail-' + row.dataset.alertId);
            if (detailRow && detailRow.classList.contains('show')) {
                detailRow.style.display = '';
            }
        } else {
            row.style.display = 'none';
            // Hide detail row too
            const detailRow = document.getElementById('detail-' + row.dataset.alertId);
            if (detailRow) {
                detailRow.style.display = 'none';
            }
        }
    });
}

// Search alerts
function searchAlerts() {
    const input = document.getElementById('searchAlerts').value.toLowerCase();
    const rows = document.querySelectorAll('.alert-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(input)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
            // Hide detail row too
            const detailRow = document.getElementById('detail-' + row.dataset.alertId);
            if (detailRow) {
                detailRow.style.display = 'none';
                detailRow.classList.remove('show');
            }
        }
    });
}

// Toggle alert detail
function toggleAlertDetail(alertId) {
    const detailRow = document.getElementById('detail-' + alertId);
    if (detailRow) {
        detailRow.classList.toggle('show');
    }
}

// Acknowledge alert
function acknowledgeAlert(alertId) {
    if (confirm('Mark this alert as acknowledged?')) {
        // In production, this would make an API call
        alert('Alert #' + alertId + ' acknowledged');
        // Remove the alert row
        const alertRow = document.querySelector(`[data-alert-id="${alertId}"]`);
        const detailRow = document.getElementById('detail-' + alertId);
        if (alertRow) alertRow.remove();
        if (detailRow) detailRow.remove();
        
        // Update counts
        updateAlertCounts();
    }
}

// View server details
function viewServer(serverName) {
    alert('Navigating to server: ' + serverName);
    // In production: window.location.href = '/server/' + serverName;
}

// Escalate alert
function escalateAlert(alertId) {
    if (confirm('Escalate this alert to senior team?')) {
        alert('Alert #' + alertId + ' escalated');
    }
}

// Refresh alerts
function refreshAlerts() {
    alert('Refreshing alerts...');
    // In production: window.location.reload();
}

// Export alerts
function exportAlerts() {
    alert('Exporting alerts to CSV...');
    // In production: implement CSV export
}

// Update alert counts
function updateAlertCounts() {
    const rows = document.querySelectorAll('.alert-row:not([style*="display: none"])');
    let critical = 0, warning = 0, online = 0;
    
    rows.forEach(row => {
        const severity = row.dataset.severity;
        if (severity === 'offline') critical++;
        else if (severity === 'warning') warning++;
        else if (severity === 'online') online++;
    });
    
    document.getElementById('totalAlerts').textContent = rows.length;
    document.getElementById('criticalCount').textContent = critical;
    document.getElementById('warningCount').textContent = warning;
    document.getElementById('infoCount').textContent = online;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Alerts page loaded');
});
</script>
{% endblock %}