<!-- templates/dependencies.html - Application Dependencies Dashboard -->
{% extends "base.html" %}

{% block title %}Dotsh - Application Dependencies{% endblock %}

{% block content %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #667eea;
    }
    .stat-label {
        font-size: 13px;
        color: #718096;
        text-transform: uppercase;
        margin-bottom: 8px;
    }
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #2d3748;
    }
    .view-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        border-bottom: 2px solid #e2e8f0;
    }
    .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        color: #718096;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 15px;
    }
    .tab-btn:hover {
        color: #667eea;
    }
    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    .view-content {
        display: none;
    }
    .view-content.active {
        display: block;
    }
    .search-filter-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .filter-label {
        font-size: 13px;
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
    }
    .filter-input, .filter-select {
        padding: 10px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s;
    }
    .filter-input:focus, .filter-select:focus {
        border-color: #667eea;
    }
    .dependencies-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .dependencies-table table {
        width: 100%;
        border-collapse: collapse;
    }
    .dependencies-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .dependencies-table th {
        padding: 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .dependencies-table td {
        padding: 16px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
        color: #2d3748;
    }
    .dependencies-table tbody tr {
        transition: background 0.2s;
    }
    .dependencies-table tbody tr:hover {
        background: #f7fafc;
    }
    .ciid-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }
    .ciid-link:hover {
        color: #764ba2;
        text-decoration: underline;
    }
    .connection-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        background: #eef2ff;
        color: #667eea;
        text-transform: uppercase;
        display: inline-block;
    }
    .lob-text {
        font-size: 12px;
        color: #718096;
    }
    .arrow-icon {
        color: #667eea;
        font-size: 18px;
        font-weight: bold;
    }
    #graph-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: 700px;
        position: relative;
    }
    .graph-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 100;
        display: flex;
        gap: 8px;
    }
    .graph-btn {
        padding: 8px 16px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    .graph-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }
    .legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 16px;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        font-size: 12px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .legend-item:last-child {
        margin-bottom: 0;
    }
    .legend-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    .empty-state {
        text-align: center;
        padding: 60px;
        color: #718096;
    }
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        opacity: 0.3;
    }
    .tooltip-graph {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        display: none;
        z-index: 1000;
    }
</style>

<div class="dashboard">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='{{ url_for('dashboard') }}'">
            dotsh<span class="logo-dot">.</span>
        </div>
        
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Overview</span>
            </a>

            <a href="{{ url_for('capacity') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="3" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="10" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="17" width="20" height="5" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Server Capacity</span>
            </a>

            <a href="{{ url_for('projects') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke-width="2"/>
                </svg>
                <span class="tooltip">Project Servers</span>
            </a>

            <a href="{{ url_for('dependencies') }}" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17 8l4 4m0 0l-4 4m4-4H3" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="7" cy="12" r="2" stroke-width="2"/>
                    <circle cx="17" cy="12" r="2" stroke-width="2"/>
                </svg>
                <span class="tooltip">Dependencies</span>
            </a>

            <a href="{{ url_for('alerts') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"/>
                </svg>
                <span class="tooltip">Alerts</span>
            </a>

            <a href="{{ url_for('logout') }}" class="nav-item nav-logout" onclick="return confirm('Are you sure you want to logout?')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke-width="2"/>
                    <polyline points="16 17 21 12 16 7" stroke-width="2"/>
                    <line x1="21" y1="12" x2="9" y2="12" stroke-width="2"/>
                </svg>
                <span class="tooltip">Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="header">
            <h1>Application Dependencies</h1>
            <p>Visualize and manage application dependencies across all ITAM CIIDs</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Dependencies</div>
                <div class="stat-value">{{ stats.total_dependencies }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Applications</div>
                <div class="stat-value">{{ stats.total_applications }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Connection Types</div>
                <div class="stat-value">{{ stats.unique_connection_types }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Apps with Dependencies</div>
                <div class="stat-value">{{ stats.applications_with_dependencies }}</div>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="tab-btn active" onclick="switchView('table')">
                <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none">
                    <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                </svg>
                Table View
            </button>
            <button class="tab-btn" onclick="switchView('graph')">
                <svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;" viewBox="0 0 24 24" fill="none">
                    <circle cx="7" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    <circle cx="17" cy="6" r="3" stroke="currentColor" stroke-width="2"/>
                    <circle cx="17" cy="18" r="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M10 11l4-3m-4 4l4 3" stroke="currentColor" stroke-width="2"/>
                </svg>
                Graph View
            </button>
        </div>

        <!-- Table View -->
        <div id="table-view" class="view-content active">
            <!-- Search and Filter Bar -->
            <div class="search-filter-bar">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Search Source CIID</label>
                        <input type="text" class="filter-input" id="filterSourceCIID" placeholder="Enter source ITAM CIID..." onkeyup="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Search Upstream CIID</label>
                        <input type="text" class="filter-input" id="filterUpstreamCIID" placeholder="Enter upstream ITAM CIID..." onkeyup="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Connection Type</label>
                        <select class="filter-select" id="filterConnectionType" onchange="filterTable()">
                            <option value="">All Types</option>
                            {% set connection_types = dependencies|map(attribute='connection_type')|unique|list %}
                            {% for type in connection_types|sort %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Search LOB</label>
                        <input type="text" class="filter-input" id="filterLOB" placeholder="Enter LOB name..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>

            <!-- Dependencies Table -->
            {% if dependencies %}
            <div class="dependencies-table">
                <table>
                    <thead>
                        <tr>
                            <th>Source ITAM CIID</th>
                            <th>Source LOB</th>
                            <th></th>
                            <th>Upstream ITAM CIID</th>
                            <th>Upstream LOB</th>
                            <th>Connection Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dependenciesTableBody">
                        {% for dep in dependencies %}
                        <tr class="dependency-row" 
                            data-source="{{ dep.source_ciid|lower }}" 
                            data-upstream="{{ dep.upstream_ciid|lower if dep.upstream_ciid else '' }}"
                            data-connection="{{ dep.connection_type|lower }}"
                            data-lob="{{ (dep.source_lob + ' ' + dep.upstream_lob)|lower }}">
                            <td>
                                <a href="{{ url_for('project_detail_itam_ciid', project_id=dep.source_ciid) }}" class="ciid-link">
                                    {{ dep.source_ciid }}
                                </a>
                                <div class="lob-text">{{ dep.source_lob }}</div>
                            </td>
                            <td>{{ dep.source_lob }}</td>
                            <td style="text-align: center;">
                                <span class="arrow-icon">→</span>
                            </td>
                            <td>
                                {% if dep.upstream_ciid %}
                                <a href="{{ url_for('project_detail_itam_ciid', project_id=dep.upstream_ciid) }}" class="ciid-link">
                                    {{ dep.upstream_ciid }}
                                </a>
                                <div class="lob-text">{{ dep.upstream_lob }}</div>
                                {% else %}
                                <span style="color: #cbd5e0;">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ dep.upstream_lob if dep.upstream_ciid else 'N/A' }}</td>
                            <td>
                                <span class="connection-badge">{{ dep.connection_type }}</span>
                            </td>
                            <td>
                                <button class="graph-btn" onclick="highlightInGraph('{{ dep.source_ciid }}', '{{ dep.upstream_ciid }}')">
                                    View in Graph
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none">
                    <path d="M17 8l4 4m0 0l-4 4m4-4H3" stroke="currentColor" stroke-width="2"/>
                </svg>
                <h3>No Dependencies Found</h3>
                <p>No application dependencies have been configured yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- Graph View -->
        <div id="graph-view" class="view-content">
            <div id="graph-container">
                <div class="graph-controls">
                    <button class="graph-btn" onclick="resetGraph()">Reset View</button>
                    <button class="graph-btn" onclick="fitGraph()">Fit to Screen</button>
                </div>
                <div class="legend">
                    <div style="font-weight: 600; margin-bottom: 12px;">Legend</div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: #667eea;"></div>
                        <span>Application Node</span>
                    </div>
                    <div class="legend-item">
                        <span style="color: #667eea; font-weight: bold;">→</span>
                        <span>Dependency Link</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 2px; background: #667eea;"></div>
                        <span>Connection</span>
                    </div>
                </div>
                <svg id="dependency-graph"></svg>
            </div>
            <div class="tooltip-graph" id="graph-tooltip"></div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// View switching
function switchView(view) {
    // Update tabs
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.tab-btn').classList.add('active');
    
    // Update views
    document.querySelectorAll('.view-content').forEach(content => content.classList.remove('active'));
    document.getElementById(view + '-view').classList.add('active');
    
    if (view === 'graph') {
        initGraph();
    }
}

// Table filtering
function filterTable() {
    const sourceCIID = document.getElementById('filterSourceCIID').value.toLowerCase();
    const upstreamCIID = document.getElementById('filterUpstreamCIID').value.toLowerCase();
    const connectionType = document.getElementById('filterConnectionType').value.toLowerCase();
    const lob = document.getElementById('filterLOB').value.toLowerCase();
    
    const rows = document.querySelectorAll('.dependency-row');
    
    rows.forEach(row => {
        const rowSource = row.getAttribute('data-source') || '';
        const rowUpstream = row.getAttribute('data-upstream') || '';
        const rowConnection = row.getAttribute('data-connection') || '';
        const rowLOB = row.getAttribute('data-lob') || '';
        
        const matchesSource = !sourceCIID || rowSource.includes(sourceCIID);
        const matchesUpstream = !upstreamCIID || rowUpstream.includes(upstreamCIID);
        const matchesConnection = !connectionType || rowConnection === connectionType;
        const matchesLOB = !lob || rowLOB.includes(lob);
        
        if (matchesSource && matchesUpstream && matchesConnection && matchesLOB) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// D3.js Graph Visualization
let simulation, svg, link, node, text;
const graphData = {
    nodes: {{ nodes|tojson|safe }},
    links: {{ links|tojson|safe }}
};

function initGraph() {
    // Clear existing graph
    d3.select('#dependency-graph').selectAll('*').remove();
    
    const container = document.getElementById('graph-container');
    const width = container.clientWidth - 40;
    const height = container.clientHeight - 40;
    
    svg = d3.select('#dependency-graph')
        .attr('width', width)
        .attr('height', height);
    
    // Create arrow markers
    svg.append('defs').selectAll('marker')
        .data(['end'])
        .enter().append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 20)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#667eea');
    
    // Create force simulation
    simulation = d3.forceSimulation(graphData.nodes)
        .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(150))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));
    
    // Create links
    link = svg.append('g')
        .selectAll('line')
        .data(graphData.links)
        .enter().append('line')
        .attr('stroke', '#667eea')
        .attr('stroke-width', 2)
        .attr('marker-end', 'url(#arrow)')
        .attr('opacity', 0.6);
    
    // Create nodes
    node = svg.append('g')
        .selectAll('circle')
        .data(graphData.nodes)
        .enter().append('circle')
        .attr('r', d => d.size || 10)
        .attr('fill', d => d3.schemeCategory10[d.group % 10])
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .call(drag(simulation))
        .on('mouseover', showTooltip)
        .on('mouseout', hideTooltip)
        .on('click', nodeClick);
    
    // Create labels
    text = svg.append('g')
        .selectAll('text')
        .data(graphData.nodes)
        .enter().append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', -15)
        .attr('font-size', '11px')
        .attr('font-weight', 'bold')
        .attr('fill', '#2d3748')
        .text(d => d.id);
    
    // Update positions on simulation tick
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        
        node
            .attr('cx', d => d.x)
            .attr('cy', d => d.y);
        
        text
            .attr('x', d => d.x)
            .attr('y', d => d.y);
    });
}

// Drag behavior
function drag(simulation) {
    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }
    
    function dragged(event) {
        event.subject.fx = event.constraint.x;
        event.subject.fy = event.y;
    }
    
    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
    
    return d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);
}

// Tooltip functions
function showTooltip(event, d) {
    const tooltip = document.getElementById('graph-tooltip');
    tooltip.innerHTML = `
        <strong>${d.id}</strong><br>
        LOB: ${d.lob}<br>
        Upstream: ${d.upstream_count}<br>
        Downstream: ${d.downstream_count}
    `;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.pageX + 10) + 'px';
    tooltip.style.top = (event.pageY - 10) + 'px';
}

function hideTooltip() {
    document.getElementById('graph-tooltip').style.display = 'none';
}

function nodeClick(event, d) {
    window.location.href = `/project/itam-ciid/${d.id}`;
}

// Graph controls
function resetGraph() {
    if (simulation) {
        simulation.alpha(1).restart();
    }
}

function fitGraph() {
    initGraph();
}

function highlightInGraph(source, target) {
    switchView('graph');
    setTimeout(() => {
        // Highlight specific nodes
        node.attr('opacity', d => (d.id === source || d.id === target) ? 1 : 0.3);
        link.attr('opacity', d => (d.source.id === source && d.target.id === target) ? 1 : 0.1);
    }, 500);
}
</script>
{% endblock %}