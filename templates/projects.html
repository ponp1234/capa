<!-- templates/projects.html -->
{% extends "base.html" %}

{% block title %}Dotsh - Project Servers{% endblock %}

{% block content %}
<style>
    .search-box {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
    }
    .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 15px;
        outline: none;
    }
    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .project-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    .project-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
    }
    .project-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
    }
    .project-meta {
        font-size: 13px;
        color: #718096;
        margin-bottom: 16px;
    }
    .env-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .env-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }
    .env-badge.dev {
        background: #e0e7ff;
        color: #4338ca;
    }
    .env-badge.stage {
        background: #fef3c7;
        color: #92400e;
    }
    .env-badge.prod {
        background: #d1fae5;
        color: #065f46;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }
    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 1200px;
        width: 95%;
        max-height: 90vh;
        overflow: auto;
        position: relative;
    }
    .modal-header {
        padding: 30px;
        border-bottom: 2px solid #f7fafc;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }
    .modal-close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 28px;
        font-weight: bold;
        color: #718096;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.3s;
    }
    .modal-close:hover {
        background: #f7fafc;
        color: #2d3748;
    }
    .modal-body {
        padding: 30px;
    }
    .tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        border-bottom: 2px solid #e2e8f0;
    }
    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 15px;
        font-weight: 600;
        color: #718096;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s;
    }
    .tab:hover {
        color: #4a5568;
    }
    .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .summary-item {
        background: #f7fafc;
        padding: 16px;
        border-radius: 8px;
    }
    .summary-label {
        font-size: 12px;
        color: #718096;
        margin-bottom: 4px;
    }
    .summary-value {
        font-size: 20px;
        font-weight: 600;
        color: #2d3748;
    }
    .compute-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .compute-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
    }
    .compute-header {
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 12px;
    }
    .compute-detail {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f7fafc;
        font-size: 13px;
    }
    .compute-detail:last-child {
        border-bottom: none;
    }
    .compute-label {
        color: #718096;
    }
    .compute-value {
        font-weight: 600;
        color: #2d3748;
    }
</style>

<div class="dashboard">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='{{ url_for('dashboard') }}'">
            dotsh<span class="logo-dot">.</span>
        </div>
        
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Overview</span>
            </a>

            <a href="{{ url_for('capacity') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="3" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="10" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="17" width="20" height="5" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Server Capacity</span>
            </a>

            <a href="{{ url_for('projects') }}" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke-width="2"/>
                </svg>
                <span class="tooltip">Project Servers</span>
            </a>

            <a href="{{ url_for('alerts') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"/>
                </svg>
                <span class="tooltip">Alerts</span>
            </a>

            <a href="{{ url_for('logout') }}" class="nav-item nav-logout" onclick="return confirm('Are you sure you want to logout?')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke-width="2"/>
                    <polyline points="16 17 21 12 16 7" stroke-width="2"/>
                    <line x1="21" y1="12" x2="9" y2="12" stroke-width="2"/>
                </svg>
                <span class="tooltip">Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="header">
            <h1>Project Servers</h1>
            <p>Manage and monitor all your project environments</p>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search projects by name..." onkeyup="searchProjects()">
            <button class="search-btn" onclick="searchProjects()">
                <svg style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" fill="none">
                    <circle cx="11" cy="11" r="8" stroke="white" stroke-width="2"/>
                    <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Search
            </button>
        </div>

        <!-- Projects Grid -->
        <div class="projects-grid" id="projectsGrid">
            {% if projects %}
                {% for project in projects %}
                <div class="project-card" onclick="openProjectModal({{ project.id }})">
                    <div class="project-name">{{ project.name }}</div>
                    <div class="project-meta">
                        <strong>Owner:</strong> {{ project.owner }}<br>
                        <strong>Created:</strong> {{ project.created_at.strftime('%b %d, %Y') }}
                    </div>
                    <div class="env-badges">
                        {% for env in project.environments %}
                        <span class="env-badge {{ env.environment_type }}">
                            {{ env.environment_type|upper }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: #718096;">
                    <svg style="width: 64px; height: 64px; margin: 0 auto 20px; opacity: 0.3;" viewBox="0 0 24 24" fill="none">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <h3 style="margin-bottom: 8px;">No Projects Found</h3>
                    <p>Create your first project to get started</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalProjectName" style="font-size: 28px; color: #2d3748; margin-bottom: 8px;"></h2>
            <p id="modalProjectMeta" style="color: #718096;"></p>
            <span class="modal-close" onclick="closeProjectModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <!-- Environment Tabs -->
            <div class="tabs" id="envTabs"></div>
            
            <!-- Tab Contents -->
            <div id="tabContents"></div>
        </div>
    </div>
</div>

<script>
// Project data for modal
const projectsData = {{ projects_json | safe }};

function searchProjects() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.querySelectorAll('.project-card');
    
    cards.forEach(card => {
        const name = card.querySelector('.project-name').textContent.toLowerCase();
        if (name.includes(input)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function openProjectModal(projectId) {
    const project = projectsData.find(p => p.id === projectId);
    if (!project) return;
    
    // Set modal header
    document.getElementById('modalProjectName').textContent = project.name;
    document.getElementById('modalProjectMeta').textContent = 
        `Owner: ${project.owner} â€¢ Created: ${project.created_date}`;
    
    // Create tabs
    const tabsHtml = project.environments.map((env, index) => 
        `<button class="tab ${index === 0 ? 'active' : ''}" onclick="switchTab(event, 'env${env.id}')">
            ${env.environment_type.toUpperCase()}
        </button>`
    ).join('');
    document.getElementById('envTabs').innerHTML = tabsHtml;
    
    // Create tab contents
    const contentsHtml = project.environments.map((env, index) => {
        const totalCores = env.servers.reduce((sum, s) => sum + s.cpu_cores, 0);
        const totalRam = env.servers.reduce((sum, s) => sum + parseInt(s.ram.replace(' GB', '')), 0);
        const totalStorage = env.servers.reduce((sum, s) => sum + parseFloat(s.storage.replace(' TB', '').replace(' GB', '')), 0);
        const avgCpu = (env.servers.reduce((sum, s) => sum + s.cpu_usage, 0) / env.servers.length).toFixed(1);
        
        return `
            <div id="env${env.id}" class="tab-content ${index === 0 ? 'active' : ''}">
                <!-- Environment Summary -->
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Total Servers</div>
                        <div class="summary-value">${env.servers.length}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total CPU Cores</div>
                        <div class="summary-value">${totalCores}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total RAM</div>
                        <div class="summary-value">${totalRam} GB</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Storage</div>
                        <div class="summary-value">${totalStorage.toFixed(2)} TB</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg CPU Usage</div>
                        <div class="summary-value">${avgCpu}%</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Region</div>
                        <div class="summary-value">${env.region}</div>
                    </div>
                </div>
                
                <!-- Server Compute Details -->
                <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 16px;">Server Details</h3>
                <div class="compute-grid">
                    ${env.servers.map(server => `
                        <div class="compute-card">
                            <div class="compute-header">
                                ${server.name}
                                <span class="status-badge ${server.status}" style="float: right; font-size: 10px;">
                                    ${server.status.toUpperCase()}
                                </span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">IP Address</span>
                                <span class="compute-value">${server.ip_address}</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">Operating System</span>
                                <span class="compute-value">${server.os}</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">CPU Cores</span>
                                <span class="compute-value">${server.cpu_cores} Cores</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">CPU Usage</span>
                                <span class="compute-value">${server.cpu_usage}%</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">RAM</span>
                                <span class="compute-value">${server.ram}</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">RAM Usage</span>
                                <span class="compute-value">${server.ram_usage}%</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">Storage</span>
                                <span class="compute-value">${server.storage}</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">Storage Used</span>
                                <span class="compute-value">${server.storage_used}%</span>
                            </div>
                            <div class="compute-detail">
                                <span class="compute-label">Uptime</span>
                                <span class="compute-value">${server.uptime}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Services Table -->
                <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 16px;">Running Services</h3>
                <div class="content-section" style="padding: 0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Server</th>
                                <th>Service</th>
                                <th>Port</th>
                                <th>Status</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${env.servers.map(server => 
                                server.services.map(service => `
                                    <tr>
                                        <td><strong>${server.name}</strong></td>
                                        <td>${service.name}</td>
                                        <td>${service.port}</td>
                                        <td><span class="status-badge ${service.status}">${service.status.toUpperCase()}</span></td>
                                        <td>${service.response_time}</td>
                                    </tr>
                                `).join('')
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('tabContents').innerHTML = contentsHtml;
    
    // Show modal
    document.getElementById('projectModal').classList.add('active');
}

function closeProjectModal() {
    document.getElementById('projectModal').classList.remove('active');
}

function switchTab(event, tabId) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    event.target.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('projectModal');
    if (event.target == modal) {
        closeProjectModal();
    }
}
</script>
{% endblock %}

