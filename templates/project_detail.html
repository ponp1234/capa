<!-- templates/project_detail.html -->
{% extends "base.html" %}

{% block title %}{{ project.name }} - Dotsh{% endblock %}

{% block content %}
<style>
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
        font-size: 14px;
        color: #718096;
    }
    .breadcrumb a {
        color: #667eea;
        text-decoration: none;
    }
    .breadcrumb a:hover {
        text-decoration: underline;
    }
    .project-header-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .project-title-row {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 20px;
    }
    .project-title {
        font-size: 32px;
        color: #2d3748;
        margin-bottom: 8px;
    }
    .project-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .info-item {
        padding: 16px;
        background: #f7fafc;
        border-radius: 8px;
    }
    .info-label {
        font-size: 12px;
        color: #718096;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .info-value {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }
    .tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        border-bottom: 2px solid #e2e8f0;
        background: white;
        padding: 20px 20px 0 20px;
        border-radius: 12px 12px 0 0;
    }
    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 15px;
        font-weight: 600;
        color: #718096;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tab:hover {
        color: #4a5568;
    }
    .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    .tab-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }
    .tab-badge.dev {
        background: #e0e7ff;
        color: #4338ca;
    }
    .tab-badge.stage {
        background: #fef3c7;
        color: #92400e;
    }
    .tab-badge.prod {
        background: #d1fae5;
        color: #065f46;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .summary-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #667eea;
    }
    .summary-label {
        font-size: 12px;
        color: #718096;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    .summary-value {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
    }
    .servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    .server-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }
    .server-card:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    .server-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f7fafc;
    }
    .server-name {
        font-size: 16px;
        font-weight: 600;
        color: #2d3748;
    }
    .server-detail {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 13px;
        border-bottom: 1px solid #f7fafc;
    }
    .server-detail:last-child {
        border-bottom: none;
    }
    .server-label {
        color: #718096;
    }
    .server-value {
        font-weight: 600;
        color: #2d3748;
    }
    .metrics-row {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #f7fafc;
    }
    .metric-item {
        margin-bottom: 12px;
    }
    .metric-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 12px;
    }
    .metric-label {
        color: #718096;
    }
    .metric-value {
        font-weight: 600;
        color: #2d3748;
    }
    .back-button {
        padding: 10px 20px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        color: #4a5568;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .back-button:hover {
        border-color: #667eea;
        color: #667eea;
    }
</style>

<div class="dashboard">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='{{ url_for('dashboard') }}'">
            dotsh<span class="logo-dot">.</span>
        </div>
        
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Overview</span>
            </a>

            <a href="{{ url_for('capacity') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="3" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="10" width="20" height="5" rx="1" stroke-width="2"/>
                    <rect x="2" y="17" width="20" height="5" rx="1" stroke-width="2"/>
                </svg>
                <span class="tooltip">Server Capacity</span>
            </a>

            <a href="{{ url_for('projects') }}" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke-width="2"/>
                </svg>
                <span class="tooltip">Project Servers</span>
            </a>

            <a href="{{ url_for('alerts') }}" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"/>
                </svg>
                <span class="tooltip">Alerts</span>
            </a>

            <a href="{{ url_for('logout') }}" class="nav-item nav-logout" onclick="return confirm('Are you sure you want to logout?')">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke-width="2"/>
                    <polyline points="16 17 21 12 16 7" stroke-width="2"/>
                    <line x1="21" y1="12" x2="9" y2="12" stroke-width="2"/>
                </svg>
                <span class="tooltip">Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <span>›</span>
            <a href="{{ url_for('projects') }}">Projects</a>
            <span>›</span>
            <span>{{ project.name }}</span>
        </div>

        <!-- Project Header -->
        <div class="project-header-section">
            <div class="project-title-row">
                <div>
                    <h1 class="project-title">{{ project.name }}</h1>
                    <p style="color: #718096; font-size: 16px;">{{ project.description or 'No description available' }}</p>
                </div>
                <a href="{{ url_for('projects') }}" class="back-button">
                    ← Back to Projects
                </a>
            </div>
            
            <div class="project-info-grid">
                <div class="info-item">
                    <div class="info-label">Owner</div>
                    <div class="info-value">{{ project.owner }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Environments</div>
                    <div class="info-value">{{ environments|length }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Servers</div>
                    <div class="info-value">
                        {% set total_servers = namespace(count=0) %}
                        {% for env in environments %}
                            {% set total_servers.count = total_servers.count + env.servers|length %}
                        {% endfor %}
                        {{ total_servers.count }}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Created</div>
                    <div class="info-value">{{ project.created_at.strftime('%b %d, %Y') }}</div>
                </div>
            </div>
        </div>

        <!-- Environment Tabs -->
        <div class="tabs">
            {% for env in environments %}
            <button class="tab {% if loop.first %}active{% endif %}" onclick="switchTab(event, 'env-{{ env.id }}')">
                <span>{{ env.type|upper }}</span>
                <span class="tab-badge {{ env.type }}">{{ env.servers|length }} servers</span>
            </button>
            {% endfor %}
        </div>

        <!-- Tab Contents -->
        {% for env in environments %}
        <div id="env-{{ env.id }}" class="tab-content {% if loop.first %}active{% endif %}">
            <!-- Environment Summary -->
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Total Servers</div>
                    <div class="summary-value">{{ env.servers|length }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total CPU Cores</div>
                    <div class="summary-value">
                        {{ env.servers|sum(attribute='cpu_cores') }}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total RAM</div>
                    <div class="summary-value">
                        {% set total_ram = namespace(value=0) %}
                        {% for server in env.servers %}
                            {% set total_ram.value = total_ram.value + server.ram.replace(' GB', '')|int %}
                        {% endfor %}
                        {{ total_ram.value }} GB
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Avg CPU Usage</div>
                    <div class="summary-value">
                        {% if env.servers|length > 0 %}
                            {{ (env.servers|sum(attribute='cpu_usage') / env.servers|length)|int }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Region</div>
                    <div class="summary-value" style="font-size: 16px;">{{ env.region }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Services</div>
                    <div class="summary-value">
                        {% set total_services = namespace(count=0) %}
                        {% for server in env.servers %}
                            {% set total_services.count = total_services.count + server.services|length %}
                        {% endfor %}
                        {{ total_services.count }}
                    </div>
                </div>
            </div>

            <!-- Servers Grid -->
            <h3 style="font-size: 20px; color: #2d3748; margin-bottom: 20px; font-weight: 600;">Servers</h3>
            <div class="servers-grid">
                {% for server in env.servers %}
                <div class="server-card">
                    <div class="server-header">
                        <div class="server-name">{{ server.name }}</div>
                        <span class="status-badge {{ server.status }}">{{ server.status|upper }}</span>
                    </div>
                    
                    <div class="server-detail">
                        <span class="server-label">IP Address</span>
                        <span class="server-value">{{ server.ip_address }}</span>
                    </div>
                    <div class="server-detail">
                        <span class="server-label">Operating System</span>
                        <span class="server-value">{{ server.os }}</span>
                    </div>
                    <div class="server-detail">
                        <span class="server-label">Uptime</span>
                        <span class="server-value">{{ server.uptime }}</span>
                    </div>
                    
                    <div class="metrics-row">
                        <!-- CPU Metric -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-label">CPU ({{ server.cpu_cores }} cores)</span>
                                <span class="metric-value">{{ server.cpu_usage }}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill {% if server.cpu_usage < 50 %}low{% elif server.cpu_usage < 80 %}medium{% else %}high{% endif %}" 
                                     style="width: {{ server.cpu_usage }}%"></div>
                            </div>
                        </div>
                        
                        <!-- RAM Metric -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-label">RAM ({{ server.ram }})</span>
                                <span class="metric-value">{{ server.ram_usage }}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill {% if server.ram_usage < 50 %}low{% elif server.ram_usage < 80 %}medium{% else %}high{% endif %}" 
                                     style="width: {{ server.ram_usage }}%"></div>
                            </div>
                        </div>
                        
                        <!-- Storage Metric -->
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-label">Storage ({{ server.storage }})</span>
                                <span class="metric-value">{{ server.storage_used }}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill {% if server.storage_used < 50 %}low{% elif server.storage_used < 80 %}medium{% else %}high{% endif %}" 
                                     style="width: {{ server.storage_used }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Services Table -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Running Services</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Server</th>
                                <th>Service</th>
                                <th>Port</th>
                                <th>Status</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for server in env.servers %}
                                {% for service in server.services %}
                                <tr>
                                    <td><strong>{{ server.name }}</strong></td>
                                    <td>{{ service.name }}</td>
                                    <td>{{ service.port }}</td>
                                    <td><span class="status-badge {{ service.status }}">{{ service.status|upper }}</span></td>
                                    <td>{{ service.response_time }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #718096;">
                                        No services configured
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function switchTab(event, tabId) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    event.currentTarget.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}
</script>
{% endblock %}